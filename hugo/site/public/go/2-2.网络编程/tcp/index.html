<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.96.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>TCP协议 &middot; Blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="/public/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="/public/css/poole.css">
  <link type="text/css" rel="stylesheet" href="/public/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="/public/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="/public/css/bootstrap-iso.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body style="background-color: #e8e8e8;">
	<div class="bootstrap-iso">
		<div class="container-fluid">
			<div class="row">
				
				<div class="col-md-2">
					
				</div>
				
				<div class="col-md-8">
					<nav class="navbar navbar-default  nav-stacked" role="navigation">
					    <div class="container-fluid">
							<div class="navbar-header">
								<button type="button" class="navbar-toggle" data-toggle="collapse"
										data-target="#example-navbar-collapse">
									<span class="sr-only">切换导航</span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
								<a class="navbar-brand" href="/">Home</a>
							</div>
							<div class="collapse navbar-collapse" id="example-navbar-collapse">
								<ul class="nav navbar-nav">
									<li id="hot"><a href="/hot">资讯</a></li>
									<li id="tool"><a href="/tool">导航</a></li>
									<li id="public"><a href="/public">随笔</a></li>
									<li><a href="#">关于</a></li>
								</ul>
								<i class="navbar-text navbar-right" style="color: #AC2925;"><b>The winner takes it all.</b></i>
							</div>
							
					    </div>
					</nav>
				</div>
				
				<div class="col-md-2">
					
				</div>
				
			</div>
		</div>
	</div>
	
	<div class="theme-base-08 ">
		
		<main class="content container">
		<div class="post">
  <h1>TCP协议</h1>
  <time datetime=2022-05-06T10:26:00&#43;0800 class="post-date">Fri, May 6, 2022</time>
  <p><a href="https://liuyehcf.github.io/2019/10/28/TCP-IP%E8%AF%A6%E8%A7%A3-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">https://liuyehcf.github.io/2019/10/28/TCP-IP%E8%AF%A6%E8%A7%A3-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</a></p>
<h3 id="术语">术语</h3>
<ul>
<li>ARQ（Automatic repeat request）：自动重复请求</li>
<li>面向连接、可靠的字节流、全双工</li>
<li>一个TCP连接由一个套接字（四元组）标识，四元组：由IP头中的源ip和目的ip、tcp头中的源端口和目的端口组成</li>
</ul>
<h3 id="抓包">抓包</h3>
<h4 id="wireshark">wireshark</h4>
<p>常用过滤规则：<a href="https://blog.csdn.net/liu_yanxiaobai/article/details/124943492">https://blog.csdn.net/liu_yanxiaobai/article/details/124943492</a></p>
<h4 id="tcpdump">tcpdump</h4>
<h3 id="命令">命令</h3>
<h4 id="telnet">telnet</h4>
<p>telnet可以建立tcp连接，一般用于端口探测</p>
<p><a href="https://blog.csdn.net/weixin_45322291/article/details/116780620">https://blog.csdn.net/weixin_45322291/article/details/116780620</a></p>
<h4 id="netstat">netstat</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@iZ8vb8qjajxkxytobaq81hZ ~<span style="color:#f92672">]</span><span style="color:#75715e"># netstat -h</span>
</span></span><span style="display:flex;"><span>-n, --numeric            don<span style="color:#960050;background-color:#1e0010">&#39;</span>t resolve names						<span style="color:#75715e"># 显示ip地址而不是域名</span>
</span></span><span style="display:flex;"><span>-l, --listening          display listening server sockets			 <span style="color:#75715e"># 只显示监听套接字</span>
</span></span><span style="display:flex;"><span>-a, --all                display all sockets <span style="color:#f92672">(</span>default: connected<span style="color:#f92672">)</span>	  <span style="color:#75715e"># 显示所有套接字</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>-t|--tcp<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>-u|--udp<span style="color:#f92672">}</span>											  <span style="color:#75715e"># 显示TCP/UDP连接</span>
</span></span><span style="display:flex;"><span>-p, --programs           display PID/Program name <span style="color:#66d9ef">for</span> sockets		  <span style="color:#75715e"># 显示对应的应用程序</span>
</span></span></code></pre></div><p>常用组合</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 显示所有tcp监听套接字</span>
</span></span><span style="display:flex;"><span>netstat -nltp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示所有tcp套接字</span>
</span></span><span style="display:flex;"><span>netstat -natp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同理udp</span>
</span></span><span style="display:flex;"><span>netstat -nlup
</span></span><span style="display:flex;"><span>netstat -naup
</span></span></code></pre></div><h3 id="tcp头部组成">TCP头部组成</h3>
<ul>
<li>16位源端口+16位目的端口</li>
<li>32位序列号：代表每个分组的第一个字节在整个数据流中的字节偏移，ISN初始序列号是随机的</li>
<li>32位确认号：表示该序列号的字节已成功接收，期待接收下一个字节，即序列号+1（只有标志位ACK开启才生效）</li>
<li>4位头部长度+4位保留+8位标志号+16位窗口大小</li>
<li>16位TCP校验和+16紧急指针（只有标志位URG开启才生效）</li>
<li>选项</li>
</ul>
<!-- raw HTML omitted -->
<h4 id="头部长度">头部长度</h4>
<p>tcp头部占20字节，选项部分最多占40字节，总长度最大为60字节
为什么总长度最大为60字节？头部长度用4位表示，最大值为15，且以4字节为单位，故15*4=60</p>
<h4 id="标志位">标志位</h4>
<ul>
<li>CWR：拥塞控制</li>
<li>ECE：拥塞控制</li>
<li>URG：当URG开启时，16位紧急指针字段才会生效</li>
<li>ACK：确认位</li>
<li>PSH：表示发送端缓存为空，即PSH数据包发送完后，发送端没有其他数据包需要传输</li>
<li>PST：重置报文段，用于错误连接、立刻终止连接等等</li>
<li>SYN：用于建立连接</li>
<li>FIN：用于断开连接</li>
</ul>
<h4 id="头部选项">头部选项</h4>
<table>
<thead>
<tr>
<th>种类</th>
<th>长度</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>4</td>
<td>MSS（Maximum segment size）</td>
<td>最大段大小，默认值：536，一般值：1500-40=1460</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>WSOPT（window scale operation）</td>
<td>窗口缩放因子（窗口左移量）</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>SACK（SACK permitted）</td>
<td>选择确认，发送者支持SACK选项</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>NOP（No Operation）</td>
<td>无操作，用作填充</td>
</tr>
</tbody>
</table>
<h3 id="tcp连接状态转换过程">TCP连接状态转换过程</h3>
<h4 id="time_wait状态">TIME_WAIT状态</h4>
<ul>
<li>tcp连接处于time_wait状态时，需要等待2MSL时长</li>
<li>Linux：net.ipv4.tcp_fin_timeout；Windows：TcpTimedWaitDelay；取值范围：30~300s</li>
<li>主动关闭的一端才会进入time_wait状态</li>
<li>影响：在2MSL时长内，端口处于占用状态，无法再次使用！</li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="tcp三次握手">TCP三次握手</h3>
<!-- raw HTML omitted -->
<h3 id="tcp服务器选项">TCP服务器选项</h3>
<ol>
<li>如何设置Local Address和Local Address？</li>
<li>监听套接字和连接套接字的区别？</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@iZ8vb8qjajxkxytobaq81hZ ~<span style="color:#f92672">]</span><span style="color:#75715e"># netstat -nltp</span>
</span></span><span style="display:flex;"><span>Active Internet connections <span style="color:#f92672">(</span>only servers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 127.0.0.1:8080          0.0.0.0:*               LISTEN      8340/./message      
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      1212/nginx: master  
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1079/sshd           
</span></span><span style="display:flex;"><span>tcp        <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> 127.0.0.1:8001          0.0.0.0:*               LISTEN      5698/v2ray          
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::3400                 :::*                    LISTEN      12761/node          
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::3800                 :::*                    LISTEN      1586/./musicAPI
</span></span></code></pre></div><ul>
<li>一台主机可能有多个IP地址</li>
<li>:::3400为IPv6格式的全零通配符，IPv4格式表现为0.0.0.0:3400</li>
<li>监听套接字：套接字处于LISTEN状态，可以接收SYN连接请求</li>
<li>连接套接字：套接字处于ESTABLISHED状态，可以传输数据</li>
</ul>
<h3 id="tcp连接队列">TCP连接队列</h3>
<h3 id="tcp重传">*TCP重传</h3>
<p>了解即可，两种方式：</p>
<ol>
<li>超时重传：基于计时器</li>
<li>快速重传：基于接收端的反馈信息来引发重传</li>
</ol>
<h3 id="tcp流量控制">*TCP流量控制</h3>
<p>了解即可，发送方比接收方快，强迫发送方降低速率</p>
<h3 id="tcp拥塞控制">*TCP拥塞控制</h3>
<p>了解即可，保护发送方和接收方之间的网络设备，如路由器</p>
<h3 id="tcp保活机制">TCP保活机制</h3>
<p>保活功能不是TCP规范的一部分，原因：</p>
<ol>
<li>在出现短暂的网络错误时，保活机制会使一个正常的连接断开</li>
<li>占用不必要的带宽</li>
<li>按流量计费的情况下，花费更多的成本</li>
</ol>
<p>保活功能一般由服务器使用，探测客户端是否奔溃或离开，从而决定是否为客户端绑定资源</p>
<p>保活功能默认关闭，TCP连接的任何一端都可以自定义开启</p>

</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "spf13" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</main>
		
		
		  
		
	</div>
	
  </body>
</html>
